[{"content":"Automate budget visibility when using cloud A good starting position with any new AWS account is to decide a budget for spend and to get notifications in place as you meet, approach or exceed this threshold. AWS provide some predictive analysis of you spend patterns too and can catch early problems before they spiral into bill shock and you are contacting their support teams with the begging bowl.\nHere is a snippet to quickly set up a $100 budget in CDK.\nconst awsBudgetTopic = new sns.Topic(this, \u0026#39;BudgetSnsTopic\u0026#39;, { displayName: \u0026#39;My AWS Budget\u0026#39;, }); awsBudgetTopic.addSubscription(new subscriptions.EmailSubscription( \u0026#39;joe@bloggs.com\u0026#39; )) const cfnBudgetProps : budgets.CfnBudgetProps = { budget: { timeUnit: \u0026#39;MONTHLY\u0026#39;, budgetType: \u0026#39;COST\u0026#39;, budgetName: \u0026#39;Base Budget\u0026#39;, budgetLimit: { amount: 100, unit: \u0026#39;USD\u0026#39;, } }, notificationsWithSubscribers: [ { notification: { notificationType: \u0026#39;ACTUAL\u0026#39;, comparisonOperator: \u0026#39;GREATER_THAN\u0026#39;, threshold: 80, thresholdType: \u0026#39;PERCENTAGE\u0026#39;, }, subscribers: [ { subscriptionType: \u0026#39;SNS\u0026#39;, address: awsBudgetTopic.topicArn, }, ], }, ], }; const baseBudget = new budgets.CfnBudget(this, \u0026#39;BaseAwsBudget\u0026#39;, cfnBudgetProps) ","permalink":"https://blog.rstu.xyz/posts/aws-budget-in-cdk/","summary":"Create an AWS Budget in CDK","title":"AWS Budgets in CDK"},{"content":"Try to use short lived credentials when using clouds GitHub\u0026rsquo;s documentation outlines the recommendation to use OIDC functionality between various cloud providers, this allows for the use of short lived credentials as opposed to statically stored secrets which need to be manually created and are prone to proliferation.\nWhen using Github repos to define parts of your AWS configuration, rather than use the manual method, a better approach is to use a CloudFormation template. A CloudFormation template can be used to create a CloudFormation stack in your AWS account to quickly form the OIDC connection between the accounts IAM identity provider feature and a specific repo, allowing for secure exchange of credentials between the pair of entities.\nPay attention to, and edit, ManagedPolicyArns section where it is recommended to scope this to the least privilege needed.\nCloudformation template AWSTemplateFormatVersion: \u0026#39;2010-09-09\u0026#39; Description: Template to create OIDC Connection Parameters: GitHubOwner: Type: String Description: Enter Github repo owner GitHubRepo: Type: String Description: Enter Github repo name Resources: IamOidcIdentityProvider: Type: AWS::IAM::OIDCProvider Properties: ClientIdList: - sts.amazonaws.com Tags: - Key: \u0026#39;Consumer\u0026#39; Value: !Sub - \u0026#39;Github Actions access for https://github.com/${RepoOwner}/${RepoName}\u0026#39; - RepoOwner: !Ref GitHubOwner RepoName: !Ref GitHubRepo ThumbprintList: - 6938fd4d98bab03faadb97b34396831e3780aea1 Url: https://token.actions.githubusercontent.com IamOidcIdpRole: Type: AWS::IAM::Role Properties: RoleName: GithubOidcRole Description: Provides administrator access Tags: - Key: \u0026#39;Consumer\u0026#39; Value: !Sub - \u0026#39;Github Actions access for https://github.com/${RepoOwner}/${RepoName}\u0026#39; - RepoOwner: !Ref GitHubOwner RepoName: !Ref GitHubRepo AssumeRolePolicyDocument: Version: \u0026#34;2012-10-17\u0026#34; Statement: - Effect: Allow Principal: Federated: !Sub - \u0026#39;arn:aws:iam::${AccountID}:oidc-provider/token.actions.githubusercontent.com\u0026#39; - AccountID: !Ref AWS::AccountId Action: sts:AssumeRoleWithWebIdentity Condition: StringLike: token.actions.githubusercontent.com:sub: !Sub - repo:${RepoOwner}/${RepoName}*:* - RepoOwner: !Ref GitHubOwner RepoName: !Ref GitHubRepo StringEquals: token.actions.githubusercontent.com:aud: sts.amazonaws.com ManagedPolicyArns: - arn:aws:iam::aws:policy/AdministratorAccess Adding to your automated workflows using Github Actions After the CloudFormation stack is installed you can now use the aws-actions/configure-aws-credentials action to transparently call for short lived credentials to be used in your workflows using the many AWS APIs, or perhaps deploy CDK deployments straight from GitHub.\n- name: Configure AWS Credentials uses: aws-actions/configure-aws-credentials@v1-node16 with: role-to-assume: arn:aws:iam::112233445566:role/GithubOidcRole role-session-name: GitHubActions-${{ github.run_id }} aws-region: eu-west-1 ","permalink":"https://blog.rstu.xyz/posts/github-aws-oidc-cloudformation/","summary":"Quickly integrating AWS and GitHub using OIDC and CloudFormation","title":"AWS/GitHub OIDC CloudFormation"}]